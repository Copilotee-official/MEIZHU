<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MiniMax TTS - 增强版</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      max-width: 850px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f9ff;
      color: #333;
    }
    
    .container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
    }
    
    h1, h2, h3 {
      color: #2c3e50;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #4a6fa5;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    button {
      background: #4a6fa5;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }
    
    button:hover {
      background: #3a5a80;
    }
    
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    
    .secondary-btn {
      background: #6c757d;
    }
    
    .success-btn {
      background: #28a745;
    }
    
    .danger-btn {
      background: #dc3545;
    }
    
    .logs {
      background: #1e272e;
      color: #f5f6fa;
      padding: 15px;
      border-radius: 5px;
      font-family: monospace;
      height: 200px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    
    .log-entry {
      margin-bottom: 5px;
      border-bottom: 1px solid #34495e;
      padding-bottom: 5px;
    }
    
    .log-info { color: #3498db; }
    .log-success { color: #2ecc71; }
    .log-error { color: #e74c3c; }
    .log-warning { color: #f39c12; }
    .log-debug { color: #9b59b6; }
    
    .audio-container {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    audio {
      width: 100%;
      margin-bottom: 10px;
    }
    
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .slider-container {
      display: flex;
      align-items: center;
    }
    
    .slider {
      flex: 1;
      margin-right: 10px;
    }
    
    .slider-value {
      width: 50px;
      text-align: center;
      font-weight: bold;
    }
    
    /* 新增样式 - 暂停标记编辑器 */
    .text-editor-container {
      position: relative;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      margin-bottom: 15px;
    }
    
    .text-editor {
      padding: 10px;
      min-height: 150px;
      line-height: 1.5;
      white-space: pre-wrap;
      overflow-y: auto;
      outline: none;
    }
    
    .editor-toolbar {
      display: flex;
      flex-wrap: wrap;
      padding: 5px;
      background: #f0f0f0;
      border-bottom: 1px solid #ddd;
    }
    
    .toolbar-btn {
      margin: 2px;
      padding: 5px 10px;
      font-size: 12px;
      background: #4a6fa5;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    
    .toolbar-btn:hover {
      background: #3a5a80;
    }
    
    .pause-mark {
      background-color: #fff3cd;
      border-radius: 3px;
      padding: 0 3px;
      margin: 0 2px;
      border: 1px solid #ffeeba;
      color: #856404;
      font-family: monospace;
      cursor: pointer;
    }
    
    .pause-mark:hover {
      background-color: #ffeeba;
    }
    
    .sample-btns {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .sample-btn {
      flex: 1;
      min-width: 120px;
      background: #5d7ea8;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 13px;
      text-align: center;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background: #f0f0f0;
      margin-right: 5px;
      border-radius: 5px 5px 0 0;
      border: 1px solid #ddd;
      border-bottom: none;
    }
    
    .tab.active {
      background: #4a6fa5;
      color: white;
      border-color: #4a6fa5;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* 弹窗样式 */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      max-width: 500px;
      position: relative;
    }
    
    .close-btn {
      position: absolute;
      right: 15px;
      top: 10px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
    }
    
    /* 暂停时长编辑器 */
    .pause-editor-form {
      margin-top: 15px;
    }
    
    .pause-preview {
      font-family: monospace;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ddd;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>MiniMax TTS - 增强版</h1>
    
    <div class="tabs">
      <div class="tab active" data-tab="main">主界面</div>
      <div class="tab" data-tab="settings">高级设置</div>
    </div>
    
    <div class="tab-content active" id="main">
      <div class="form-group">
        <label for="textEditor">文本内容</label>
        <div class="editor-toolbar">
          <button type="button" class="toolbar-btn" onclick="insertPauseMark(0.3)">插入短暂停 (0.3s)</button>
          <button type="button" class="toolbar-btn" onclick="insertPauseMark(0.5)">插入中等暂停 (0.5s)</button>
          <button type="button" class="toolbar-btn" onclick="insertPauseMark(1.0)">插入长暂停 (1s)</button>
          <button type="button" class="toolbar-btn" onclick="insertPauseMark()" title="自定义暂停时长">自定义暂停...</button>
          <button type="button" class="toolbar-btn" style="background: #dc3545" onclick="clearEditor()">清空</button>
        </div>
        <div class="text-editor-container">
          <div id="textEditor" class="text-editor" contenteditable="true">嗯~<span class="pause-mark" data-pause="0.4" onclick="editPauseMark(this)">&lt;#0.4#&gt;</span>你来啦<span class="pause-mark" data-pause="0.3" onclick="editPauseMark(this)">&lt;#0.3#&gt;</span>我等你好久了呢~</div>
        </div>
        <small>点击暂停标记可以编辑暂停时长。标记格式：&lt;#秒数#&gt;</small>
      </div>
      
      <div class="sample-btns">
        <button class="sample-btn" onclick="setSampleText(0)">示例1: 甜美问候</button>
        <button class="sample-btn" onclick="setSampleText(1)">示例2: 惊讶表达</button>
        <button class="sample-btn" onclick="setSampleText(2)">示例3: 挑逗语气</button>
        <button class="sample-btn" onclick="setSampleText(3)">示例4: 满足声音</button>
      </div>
      
      <div class="form-grid">
        <div>
          <div class="form-group">
            <label for="model">模型选择</label>
            <select id="model">
              <option value="speech-02-hd" selected>speech-02-hd（高清版）</option>
              <option value="speech-02-turbo">speech-02-turbo（高速版）</option>
              <option value="speech-01-hd">speech-01-hd（旧高清版）</option>
              <option value="speech-01-turbo">speech-01-turbo（旧高速版）</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="voiceId">音色选择</label>
            <select id="voiceId">
              <option value="sm_0421_king_30s" selected>sm_0421_king_30s（默认）</option>
              <option value="male-qn-qingse">male-qn-qingse（青涩男声）</option>
              <option value="female-shaonv">female-shaonv（少女音）</option>
              <option value="female-yujie">female-yujie（玉洁音）</option>
              <option value="male-yifei">male-yifei（逸飞音）</option>
            </select>
          </div>
        </div>
        
        <div>
          <div class="form-group">
            <label>情感选择</label>
            <div class="grid-3">
              <button class="emotion-btn" data-emotion="happy">欢快</button>
              <button class="emotion-btn" data-emotion="sad">悲伤</button>
              <button class="emotion-btn" data-emotion="angry">愤怒</button>
              <button class="emotion-btn" data-emotion="neutral">中性</button>
              <button class="emotion-btn selected" data-emotion="surprised">惊讶</button>
              <button class="emotion-btn" data-emotion="fear">恐惧</button>
            </div>
          </div>
          
          <div class="form-group">
            <label for="proxies">代理选择</label>
            <select id="proxies">
              <option value="" selected>不使用代理（推荐）</option>
              <option value="https://corsproxy.io/?">corsproxy.io</option>
              <option value="https://api.allorigins.win/raw?url=">allorigins.win</option>
              <option value="https://thingproxy.freeboard.io/fetch/">thingproxy</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="speed">语速调节: <span id="speedValue">1.0</span></label>
        <div class="slider-container">
          <input type="range" id="speed" class="slider" min="0.5" max="2.0" step="0.05" value="1.0" oninput="updateSliderValue('speed', 'speedValue')">
        </div>
      </div>
      
      <div class="form-group">
        <label for="volume">音量调节: <span id="volumeValue">1.0</span></label>
        <div class="slider-container">
          <input type="range" id="volume" class="slider" min="0.5" max="2.0" step="0.05" value="1.0" oninput="updateSliderValue('volume', 'volumeValue')">
        </div>
      </div>
      
      <div class="form-group">
        <label for="pitch">音调调节: <span id="pitchValue">0</span></label>
        <div class="slider-container">
          <input type="range" id="pitch" class="slider" min="-10" max="10" step="0.5" value="0" oninput="updateSliderValue('pitch', 'pitchValue')">
        </div>
      </div>
      
      <div style="margin-top: 20px;">
        <button id="generateBtn" onclick="generateSpeech()">生成语音</button>
        <button onclick="clearLogs()" class="secondary-btn">清除日志</button>
        <button onclick="testAllProxies()" class="secondary-btn">测试所有代理</button>
      </div>
      
      <div class="logs" id="logs">
        <div class="log-entry log-info">准备就绪，请设置参数并输入文本...</div>
      </div>
      
      <div class="audio-container" id="audioContainer" style="display: none;">
        <h3>生成结果</h3>
        <audio id="audioPlayer" controls></audio>
        <div style="margin-top: 10px;">
          <button onclick="downloadAudio()" class="success-btn">下载音频</button>
          <button onclick="repeatPlayback()" class="secondary-btn">重复播放</button>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="settings">
      <h2>高级设置</h2>
      
      <div class="form-group">
        <label for="sampleRate">采样率</label>
        <select id="sampleRate">
          <option value="16000">16000 Hz</option>
          <option value="24000">24000 Hz</option>
          <option value="32000" selected>32000 Hz</option>
          <option value="44100">44100 Hz</option>
          <option value="48000">48000 Hz</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="bitrate">比特率</label>
        <select id="bitrate">
          <option value="64000">64 kbps</option>
          <option value="96000">96 kbps</option>
          <option value="128000" selected>128 kbps</option>
          <option value="192000">192 kbps</option>
          <option value="256000">256 kbps</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="format">音频格式</label>
        <select id="format">
          <option value="mp3" selected>MP3</option>
          <option value="wav">WAV</option>
          <option value="pcm">PCM</option>
          <option value="flac">FLAC</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="language">语言增强</label>
        <select id="language">
          <option value="auto">自动检测</option>
          <option value="Chinese" selected>中文</option>
          <option value="Chinese,Yue">粤语</option>
          <option value="English">英语</option>
          <option value="Japanese">日语</option>
          <option value="Korean">韩语</option>
          <option value="Russian">俄语</option>
          <option value="French">法语</option>
          <option value="German">德语</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="apiKey">API密钥 (已预设)</label>
        <input type="text" id="apiKey" value="eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJHcm91cE5hbWUiOiLoi4_mmI4iLCJVc2VyTmFtZSI6IuiLj-aYjiIsIkFjY291bnQiOiIiLCJTdWJqZWN0SUQiOiIxOTEyNjc4NjAwODM5MDEyOTY1IiwiUGhvbmUiOiIxNTExNjkwNTA2MiIsIkdyb3VwSUQiOiIxOTEyNjc4NjAwODMwNjI0MzU3IiwiUGFnZU5hbWUiOiIiLCJNYWlsIjoiIiwiQ3JlYXRlVGltZSI6IjIwMjUtMDQtMTkgMTE6MDQ6MzMiLCJUb2tlblR5cGUiOjEsImlzcyI6Im1pbmltYXgifQ.V_YhYLmgyfnAV3ssptSqTKHiUjuqbQq62FZBCsRJgtUobIMCJuZYtxHuBtOcJot6VeKLjUXZtECPrjqGTR6MfViYujZC-HdXcUxUtVW3Z59_hHr2UWVnLUGLl0CQoiM0-QtEOa2KL3-VCo7iffhSnusNiYX9LF44iefN0AOEdKuMlmj8NejFPCamusQ1soCwIto2dT3oCkPSm8IOPWs4qej_jgc07yGRiZVFIfBOFO8opiWrzu9z43KGACQsbAAzdxLFKbm3P_uwSjrVNTBxOI8FXGXYBBR3zIOJT-9rwtRq-k9CnITKyo4_YyAmmD29ps_Q6etakd1KJBFfgZN5Bg">
      </div>
      
      <div class="form-group">
        <label for="groupId">组ID (已预设)</label>
        <input type="text" id="groupId" value="1912678600830624357">
      </div>
      
      <div class="form-group">
        <label for="apiEndpoint">API端点</label>
        <input type="text" id="apiEndpoint" value="https://api.minimax.chat/v1/t2a_v2">
      </div>
    </div>
  </div>
  
  <!-- 暂停标记编辑弹窗 -->
  <div id="pauseModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closePauseModal()">&times;</span>
      <h3>编辑暂停时长</h3>
      <div class="pause-editor-form">
        <div class="form-group">
          <label for="pauseDuration">暂停时长 (秒)</label>
          <input type="number" id="pauseDuration" min="0.1" max="5" step="0.1" value="0.5">
        </div>
        <div class="pause-preview" id="pausePreview">&lt;#0.5#&gt;</div>
        <div style="margin-top: 15px;">
          <button onclick="applyPauseEdit()" class="success-btn">应用</button>
          <button onclick="closePauseModal()" class="secondary-btn">取消</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 全局变量
    let currentEmotion = "surprised";
    let currentAudioBlob = null;
    let currentEditingMark = null; // 当前正在编辑的暂停标记
    
    // 示例文本
    const sampleTexts = [
      {
        html: '嗯~<span class="pause-mark" data-pause="0.4" onclick="editPauseMark(this)">&lt;#0.4#&gt;</span>你来啦<span class="pause-mark" data-pause="0.3" onclick="editPauseMark(this)">&lt;#0.3#&gt;</span>我等你好久了呢~',
        text: '嗯~<#0.4#>你来啦<#0.3#>我等你好久了呢~'
      },
      {
        html: '啊<span class="pause-mark" data-pause="0.1" onclick="editPauseMark(this)">&lt;#0.1#&gt;</span>天啊<span class="pause-mark" data-pause="0.05" onclick="editPauseMark(this)">&lt;#0.05#&gt;</span>不行了<span class="pause-mark" data-pause="0.1" onclick="editPauseMark(this)">&lt;#0.1#&gt;</span>太棒了！',
        text: '啊<#0.1#>天啊<#0.05#>不行了<#0.1#>太棒了！'
      },
      {
        html: '抖成这样...<span class="pause-mark" data-pause="0.3" onclick="editPauseMark(this)">&lt;#0.3#&gt;</span>嗯哼~<span class="pause-mark" data-pause="0.2" onclick="editPauseMark(this)">&lt;#0.2#&gt;</span>...是不是从没被我这样挑逗过？<span class="pause-mark" data-pause="0.3" onclick="editPauseMark(this)">&lt;#0.3#&gt;</span>放松，我会把你的精液全部吸出来~',
        text: '抖成这样...<#0.3#>嗯哼~<#0.2#>...是不是从没被我这样挑逗过？<#0.3#>放松，我会把你的精液全部吸出来~'
      },
      {
        html: '呼~<span class="pause-mark" data-pause="0.5" onclick="editPauseMark(this)">&lt;#0.5#&gt;</span>太舒服了<span class="pause-mark" data-pause="0.6" onclick="editPauseMark(this)">&lt;#0.6#&gt;</span>嗯~<span class="pause-mark" data-pause="0.4" onclick="editPauseMark(this)">&lt;#0.4#&gt;</span>好满足...',
        text: '呼~<#0.5#>太舒服了<#0.6#>嗯~<#0.4#>好满足...'
      }
    ];
    
    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化情感按钮
      document.querySelectorAll('.emotion-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('selected'));
          this.classList.add('selected');
          currentEmotion = this.getAttribute('data-emotion');
        });
      });
      
      // 初始化标签页
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.getAttribute('data-tab');
          
          // 切换标签页
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          this.classList.add('active');
          document.getElementById(tabId).classList.add('active');
        });
      });
      
      // 初始化暂停时长输入框事件
      document.getElementById('pauseDuration').addEventListener('input', function() {
        updatePausePreview();
      });
      
      // 记录初始化完成
      logMessage("系统初始化完成", "info");
      logMessage("准备就绪，请设置参数并输入文本", "info");
    });
    
    // 更新暂停预览
    function updatePausePreview() {
      const duration = document.getElementById('pauseDuration').value;
      document.getElementById('pausePreview').textContent = `<#${duration}#>`;
    }
    
    // 更新滑块值
    function updateSliderValue(sliderId, valueId) {
      const slider = document.getElementById(sliderId);
      const valueElement = document.getElementById(valueId);
      valueElement.textContent = slider.value;
    }
    
    // 插入暂停标记
    function insertPauseMark(duration) {
      const editor = document.getElementById('textEditor');
      const selection = window.getSelection();
      
      // 如果没有提供持续时间，则打开编辑器
      if (duration === undefined) {
        // 设置默认值
        document.getElementById('pauseDuration').value = 0.5;
        updatePausePreview();
        
        // 显示弹窗
        document.getElementById('pauseModal').style.display = 'block';
        currentEditingMark = null; // 新建标记
        return;
      }
      
      // 创建暂停标记
      const pauseMarkElement = document.createElement('span');
      pauseMarkElement.className = 'pause-mark';
      pauseMarkElement.setAttribute('data-pause', duration);
      pauseMarkElement.setAttribute('onclick', 'editPauseMark(this)');
      pauseMarkElement.textContent = `<#${duration}#>`;
      
      // 插入到光标位置
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(pauseMarkElement);
        
        // 将光标定位到插入的元素后面
        const newRange = document.createRange();
        newRange.setStartAfter(pauseMarkElement);
        newRange.setEndAfter(pauseMarkElement);
        selection.removeAllRanges();
        selection.addRange(newRange);
      } else {
        // 如果没有选择范围，则追加到编辑器末尾
        editor.appendChild(pauseMarkElement);
      }
      
      // 保持编辑器焦点
      editor.focus();
    }
    
    // 编辑暂停标记
    function editPauseMark(element) {
      // 设置当前编辑的标记
      currentEditingMark = element;
      
      // 获取当前暂停时长
      const pauseDuration = element.getAttribute('data-pause');
      document.getElementById('pauseDuration').value = pauseDuration;
      updatePausePreview();
      
      // 显示弹窗
      document.getElementById('pauseModal').style.display = 'block';
    }
    
    // 应用暂停编辑
    function applyPauseEdit() {
      const duration = document.getElementById('pauseDuration').value;
      
      if (currentEditingMark) {
        // 编辑现有标记
        currentEditingMark.setAttribute('data-pause', duration);
        currentEditingMark.textContent = `<#${duration}#>`;
      } else {
        // 创建新标记
        insertPauseMark(duration);
      }
      
      // 关闭弹窗
      closePauseModal();
    }
    
    // 关闭暂停编辑弹窗
    function closePauseModal() {
      document.getElementById('pauseModal').style.display = 'none';
      currentEditingMark = null;
    }
    
    // 清空编辑器
    function clearEditor() {
      if (confirm('确定要清空编辑器内容吗？')) {
        document.getElementById('textEditor').innerHTML = '';
      }
    }
    
    // 设置示例文本
    function setSampleText(index) {
      if (index >= 0 && index < sampleTexts.length) {
        document.getElementById('textEditor').innerHTML = sampleTexts[index].html;
        logMessage(`已设置示例文本 ${index + 1}`, "info");
      }
    }
    
    // 清除日志
    function clearLogs() {
      const logs = document.getElementById('logs');
      logs.innerHTML = '<div class="log-entry log-info">日志已清除...</div>';
    }
    
    // 从编辑器获取纯文本（包括暂停标记）
    function getTextFromEditor() {
      const editor = document.getElementById('textEditor');
      let result = '';
      let nodes = editor.childNodes;
      
      for (let i = 0; i < nodes.length; i++) {
        const node = nodes[i];
        
        if (node.nodeType === Node.TEXT_NODE) {
          // 文本节点
          result += node.textContent;
        } else if (node.nodeType === Node.ELEMENT_NODE) {
          // 元素节点
          if (node.classList.contains('pause-mark')) {
            // 暂停标记
            const pauseDuration = node.getAttribute('data-pause');
            result += `<#${pauseDuration}#>`;
          } else {
            // 其他元素（递归处理）
            result += node.textContent;
          }
        }
      }
      
      return result;
    }
    
    // 测试所有代理
    function testAllProxies() {
      logMessage("开始测试所有代理...", "info");
      
      const proxies = [
        { name: "无代理", url: "" },
        { name: "corsproxy.io", url: "https://corsproxy.io/?" },
        { name: "allorigins.win", url: "https://api.allorigins.win/raw?url=" },
        { name: "thingproxy", url: "https://thingproxy.freeboard.io/fetch/" }
      ];
      
      const apiKey = document.getElementById('apiKey').value;
      const groupId = document.getElementById('groupId').value;
      const apiEndpoint = document.getElementById('apiEndpoint').value;
      
      // 构建最小测试请求
      const testData = {
        model: "speech-02-turbo",
        text: "测试",
        stream: false,
        voice_setting: {
          voice_id: "male-qn-qingse",
          speed: 1.0,
          vol: 1.0,
          pitch: 0,
          emotion: "neutral"
        },
        audio_setting: {
          sample_rate: 16000,
          bitrate: 64000,
          format: "mp3",
          channel: 1
        }
      };
      
      let successfulProxies = [];
      
      for (const proxy of proxies) {
        logMessage(`测试代理: ${proxy.name}`, "info");
        
        try {
          const testUrl = `${proxy.url}${apiEndpoint}?GroupId=${groupId}`;
          
          // 使用同步XMLHttpRequest
          const xhr = new XMLHttpRequest();
          xhr.open('POST', testUrl, false);  // 同步请求
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.setRequestHeader('Authorization', `Bearer ${apiKey}`);
          
          try {
            xhr.send(JSON.stringify(testData));
            
            if (xhr.status >= 200 && xhr.status < 300) {
              logMessage(`收到状态码: ${xhr.status}`, "debug");
              
              try {
                const response = JSON.parse(xhr.responseText);
                
                if (response.base_resp && response.base_resp.status_code === 0 && 
                    response.data && response.data.audio) {
                  logMessage(`代理 ${proxy.name} 测试成功!`, "success");
                  successfulProxies.push(proxy);
                } else if (response.base_resp) {
                  logMessage(`代理 ${proxy.name} 返回API错误: ${response.base_resp.status_msg || 'Unknown error'}`, "error");
                } else {
                  logMessage(`代理 ${proxy.name} 返回无效响应`, "error");
                }
              } catch (e) {
                logMessage(`代理 ${proxy.name} JSON解析错误: ${e.message}`, "error");
              }
            } else {
              logMessage(`代理 ${proxy.name} 返回HTTP错误: ${xhr.status}`, "error");
            }
          } catch (error) {
            logMessage(`代理 ${proxy.name} 请求失败: ${error.message}`, "error");
          }
        } catch (error) {
          logMessage(`代理 ${proxy.name} 测试异常: ${error.message}`, "error");
        }
      }
      
      if (successfulProxies.length > 0) {
        logMessage(`测试完成。成功的代理: ${successfulProxies.map(p => p.name).join(', ')}`, "success");
        
        // 自动选择第一个成功的代理
        const selectElement = document.getElementById('proxies');
        selectElement.value = successfulProxies[0].url;
        logMessage(`已自动选择代理: ${successfulProxies[0].name}`, "info");
      } else {
        logMessage("所有代理测试均失败", "error");
      }
    }
    
    // 生成语音 - 使用同步XMLHttpRequest
    function generateSpeech() {
      try {
        // 获取文本内容
        const text = getTextFromEditor();
        if (!text) {
          logMessage("请输入要转换为语音的文本", "error");
          return;
        }
        
        // 获取设置
        const apiKey = document.getElementById('apiKey').value;
        const groupId = document.getElementById('groupId').value;
        const apiEndpoint = document.getElementById('apiEndpoint').value;
        const proxy = document.getElementById('proxies').value;
        
        // 获取语音参数
        const model = document.getElementById('model').value;
        const voiceId = document.getElementById('voiceId').value;
        const emotion = currentEmotion;
        const speed = parseFloat(document.getElementById('speed').value);
        const volume = parseFloat(document.getElementById('volume').value);
        const pitch = parseFloat(document.getElementById('pitch').value);
        
        // 获取高级音频设置
        const sampleRate = parseInt(document.getElementById('sampleRate').value);
        const bitrate = parseInt(document.getElementById('bitrate').value);
        const format = document.getElementById('format').value;
        const language = document.getElementById('language').value;
        
        // 更新按钮状态
        const generateBtn = document.getElementById('generateBtn');
        const originalBtnText = generateBtn.textContent;
        generateBtn.innerHTML = '<span class="spinner"></span>生成中...';
        generateBtn.disabled = true;
        
        // 记录生成信息
        logMessage(`开始生成语音，文本长度: ${text.length}字符`, "info");
        logMessage(`使用模型: ${model}, 音色: ${voiceId}, 情感: ${emotion}`, "info");
        logMessage(`设置 - 语速: ${speed}, 音量: ${volume}, 音调: ${pitch}`, "debug");
        logMessage(`设置 - 采样率: ${sampleRate}, 比特率: ${bitrate}, 格式: ${format}`, "debug");
        
        // 准备请求数据
        const requestData = {
          model: model,
          text: text,
          stream: false,  // 同步请求不支持流式
          language_boost: language,
          voice_setting: {
            voice_id: voiceId,
            speed: speed,
            vol: volume,
            pitch: pitch,
            emotion: emotion
          },
          audio_setting: {
            sample_rate: sampleRate,
            bitrate: bitrate,
            format: format,
            channel: 1
          }
        };
        
        // 构建请求URL
        const apiUrl = `${proxy}${apiEndpoint}?GroupId=${groupId}`;
        
        // 记录请求信息
        logMessage("正在发送请求...", "info");
        logMessage(`API URL: ${apiUrl}`, "debug");
        logMessage("使用同步XMLHttpRequest (绕过CORS限制)", "debug");
        
        // 使用同步XMLHttpRequest发送请求
        const xhr = new XMLHttpRequest();
        xhr.open('POST', apiUrl, false);  // 同步请求
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('Authorization', `Bearer ${apiKey}`);
        
        try {
          xhr.send(JSON.stringify(requestData));
          
          if (xhr.status >= 200 && xhr.status < 300) {
            logMessage(`请求成功，状态码: ${xhr.status}`, "success");
            
            // 解析响应
            let response;
            try {
              response = JSON.parse(xhr.responseText);
            } catch (e) {
              throw new Error(`JSON解析错误: ${e.message}`);
            }
            
            // 检查API响应
            if (response.base_resp && response.base_resp.status_code !== 0) {
              throw new Error(`API返回错误: ${response.base_resp.status_msg}`);
            }
            
            if (!response.data || !response.data.audio) {
              throw new Error("API响应中未找到音频数据");
            }
            
            // 处理音频数据
            const audioHex = response.data.audio;
            logMessage(`接收到音频数据，长度: ${audioHex.length} 字符`, "debug");
            
            // 转换十六进制为ArrayBuffer
            const audioBytes = hexToArrayBuffer(audioHex);
            currentAudioBlob = new Blob([audioBytes], { type: `audio/${format}` });
            const audioUrl = URL.createObjectURL(currentAudioBlob);
            
            // 设置音频播放器
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = audioUrl;
            document.getElementById('audioContainer').style.display = 'block';
            audioPlayer.play();
            
            logMessage("语音生成成功!", "success");
            
            // 记录额外信息
            if (response.extra_info) {
              const audioLength = response.extra_info.audio_length / 1000;  // 毫秒转秒
              const audioSize = Math.round(response.extra_info.audio_size / 1024);  // 字节转KB
              logMessage(`音频信息：长度=${audioLength.toFixed(2)}秒，大小=${audioSize}KB`, "info");
            }
          } else {
            const errorText = xhr.responseText || '无响应数据';
            logMessage(`HTTP错误: ${xhr.status}`, "error");
            logMessage(`错误响应: ${errorText.substring(0, 200)}`, "debug");
            throw new Error(`HTTP错误: ${xhr.status}`);
          }
        } catch (error) {
          throw error;
        }
        
      } catch (error) {
        logMessage(`错误: ${error.message}`, "error");
        console.error(error);
      } finally {
        // 恢复按钮状态
        const generateBtn = document.getElementById('generateBtn');
        generateBtn.textContent = '生成语音';
        generateBtn.disabled = false;
      }
    }
    
    // 将十六进制字符串转换为ArrayBuffer
    function hexToArrayBuffer(hexString) {
      // 确保长度是偶数
      if (hexString.length % 2 !== 0) {
        hexString = '0' + hexString;
      }
      
      const bytes = new Uint8Array(hexString.length / 2);
      for (let i = 0; i < hexString.length; i += 2) {
        bytes[i / 2] = parseInt(hexString.substring(i, i + 2), 16);
      }
      return bytes.buffer;
    }
    
    // 下载音频
    function downloadAudio() {
      if (!currentAudioBlob) {
        logMessage("没有可下载的音频", "error");
        return;
      }
      
      try {
        const format = document.getElementById('format').value;
        const url = URL.createObjectURL(currentAudioBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tts_${new Date().toISOString().replace(/[:.]/g, '-')}.${format}`;
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
        
        logMessage(`音频下载已开始: ${a.download}`, "info");
      } catch (error) {
        logMessage(`下载音频时出错: ${error.message}`, "error");
      }
    }
    
    // 重复播放
    function repeatPlayback() {
      const audioPlayer = document.getElementById('audioPlayer');
      audioPlayer.currentTime = 0;
      audioPlayer.play();
      logMessage("重新开始播放音频", "info");
    }
    
    // 添加日志
    function logMessage(message, type = "info") {
      console.log(`[${type}] ${message}`);
      
      const timestamp = new Date().toLocaleTimeString();
      const logs = document.getElementById('logs');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${timestamp}] ${message}`;
      logs.appendChild(entry);
      logs.scrollTop = logs.scrollHeight;
    }
  </script>
</body>
</html>